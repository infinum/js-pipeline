name: Build workflow

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_call:
    inputs:
      # Selects the runner on which the workflow will run
      # See: https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources
      runner:
        required: false
        type: string
        default: ubuntu-latest

      environment:
        required: true
        type: string

      # React or Angular
      # if not defined, use angular if angular.json is present, otherwise use react
      framework:
        required: false
        type: string

      # Server-side rendering or client-side rendering
      ssr:
        required: false
        type: boolean
        default: false

      # Should npm or yarn be used to install dependencies?
      # if not defined, use npm if `package-lock.json` is present, otherwise use yarn
      package_manager:
        required: false
        type: string

      # should generally be left undefined - it will default to the `.node-version` file in the root of the project
      node_version:
        required: false
        type: string

      # Slack channel name where the notifications will be sent
      slack_notification_channel:
        required: false
        type: string

      # What types of notifications should be sent?
      # Valid values:
      #   - 'success'
      #   - 'failure'
      #   - 'all'
      notify_on:
        required: false
        type: string
        default: 'all'

      # Steps that should be executed during build
      # Valid values:
      #   - 'audit'
      #   - 'lint'
      #   - 'test'
      #   - 'jest'
      #   - 'build-next'
      #   - 'analyze'
      ci_steps:
        required: true
        type: string

      # Optional features used in the project
      # Valid values:
      #   - 'secrets'
      features:
        required: false
        type: string

      # The workflow that is used for bundle analysis
      workflow:
        required: false
        type: string

      deploy_host:
        required: false
        type: string

      deploy_to:
        required: false
        type: string

      deploy_user:
        required: false
        type: string

    secrets:
      VAULT_ADDR:
        required: false
      VAULT_AUTH_METHOD:
        required: false
      VAULT_AUTH_ROLE_ID:
        required: false
      VAULT_AUTH_SECRET_ID:
        required: false
      SLACK_BOT_TOKEN:
        required: false
      SSH_PRIVATE_KEY:
        required: false

      # Additional environment variables set in the workflow
      # Format: JSON object with string values (key becomes env variable name, value becomes env variable value)
      # Example: '{ "FOO": "BAR", "BAZ": "${{ secrets.BAZ }}" }'
      ADDITIONAL_VARIABLES:
        required: false

jobs:
  setup:
    name: 'Environment setup'
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Git checkout
        uses: actions/checkout@v3
      - name: 'Bootstrap up the Node.js environment'
        uses: ./.github/actions/bootstrap-nextjs
        with:
          runner: ${{ inputs.runner }}
          package_manager: ${{ inputs.package_manager }}
          node_version: ${{ inputs.node_version }}
          env_vars: ${{ inputs.env_vars }}
      - name: Install JS packages (yarn)
        shell: bash
        if: ${{ inputs.package_manager == 'yarn' || (inputs.package_manager != 'npm' && hashFiles('yarn.lock') != '') }}
        run: yarn install --frozen-lockfile
      - name: Install JS packages (npm)
        shell: bash
        if: ${{ inputs.package_manager == 'npm' || (inputs.package_manager != 'yarn' && hashFiles('yarn.lock') == '') }}
        run: npm ci
  build-next:
    needs: [setup]
    name: 'Build next.js'
    if: ${{ contains(inputs.ci_steps, 'build-next') || contains(inputs.ci_steps, 'analyze') }}
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Set up additional environment variables
        env:
          ADDITIONAL_VARIABLES: ${{ secrets.ADDITIONAL_VARIABLES }}
        if: ${{ env.ADDITIONAL_VARIABLES }}
        run: >
          if echo '${{ env.ADDITIONAL_VARIABLES }}' | jq >/dev/null 2>&1; then
            echo '${{ env.ADDITIONAL_VARIABLES }}' | jq -r 'to_entries[] | "\(.key) \(.value)"' | \
              while read -r key value; do echo "$key=$value" >> $GITHUB_ENV && echo "Variable $key has been set"; done
          else
            echo "ADDITIONAL_VARIABLES secret you supplied is not a valid JSON object. Check the formatting of the secret."
            exit 1
          fi
      - name: Git checkout
        uses: actions/checkout@v3
      - name: 'Bootstrap up the Node.js environment'
        uses: ./.github/actions/bootstrap-nextjs
        with:
          runner: ${{ inputs.runner }}
          package_manager: ${{ inputs.package_manager }}
          node_version: ${{ inputs.node_version }}
          env_vars: ${{ inputs.env_vars }}
      - name: Run build
        shell: bash
        id: 'build'
        run: 'npm run build'
      - name: Prepare artifact
        shell: bash
        id: 'prepare-artifact'
        run: 'rm -rf .next/cache'
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: 'build'
          path: .next/**
  lint:
    needs: [setup]
    name: 'Lint the code'
    if: ${{ contains(inputs.ci_steps, 'lint') }}
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Git checkout
        uses: actions/checkout@v3
      - name: 'Bootstrap up the Node.js environment'
        uses: ./.github/actions/bootstrap-nextjs
        with:
          runner: ${{ inputs.runner }}
          package_manager: ${{ inputs.package_manager }}
          node_version: ${{ inputs.node_version }}
          env_vars: ${{ inputs.env_vars }}
      - name: Run lint
        shell: bash
        id: 'lint'
        run: 'npm run lint'
  test:
    needs: [setup]
    name: 'Run tests'
    if: ${{ contains(inputs.ci_steps, 'test') }}
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Git checkout
        uses: actions/checkout@v3
      - name: 'Bootstrap up the Node.js environment'
        uses: ./.github/actions/bootstrap-nextjs
        with:
          runner: ${{ inputs.runner }}
          package_manager: ${{ inputs.package_manager }}
          node_version: ${{ inputs.node_version }}
          env_vars: ${{ inputs.env_vars }}
      - name: Run test
        shell: bash
        id: 'test'
        run: 'npm run test'
  jest:
    needs: [setup]
    name: 'Run tests with coverage'
    if: ${{ contains(inputs.ci_steps, 'jest') }}
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Git checkout
        uses: actions/checkout@v3
      - name: 'Bootstrap up the Node.js environment'
        uses: ./.github/actions/bootstrap-nextjs
        with:
          runner: ${{ inputs.runner }}
          package_manager: ${{ inputs.package_manager }}
          node_version: ${{ inputs.node_version }}
          env_vars: ${{ inputs.env_vars }}
      - name: Test Coverage
        id: testCoverage
        uses: anuraag016/Jest-Coverage-Diff@master
        with:
          fullCoverageDiff: false
          runCommand: 'npx jest --collectCoverageFrom=''["src/**/*.{js,jsx,ts,tsx}"]'' --coverage --collectCoverage=true --coverageDirectory=''./'' --coverageReporters=''json-summary'' --forceExit --detectOpenHandles src/.*test.*'
          delta: 0.5
  analyze:
    needs: [build-next]
    name: 'Analyze the Next.js bundle size'
    if: ${{ contains(inputs.ci_steps, 'analyze') }}
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Git checkout
        uses: actions/checkout@v3
      - name: 'Analyze the bundle'
        uses: ./.github/actions/analyze
        with:
          workflow: ${{ inputs.workflow }}
  deploy-next-ssr:
    needs: [setup]
    name: 'Deploy the application'
    if: ${{ contains(inputs.ci_steps, 'deploy-next-ssr') }}
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Set up additional environment variables
        env:
          ADDITIONAL_VARIABLES: ${{ secrets.ADDITIONAL_VARIABLES }}
        if: ${{ env.ADDITIONAL_VARIABLES }}
        run: >
          if echo '${{ env.ADDITIONAL_VARIABLES }}' | jq >/dev/null 2>&1; then
            echo '${{ env.ADDITIONAL_VARIABLES }}' | jq -r 'to_entries[] | "\(.key) \(.value)"' | \
              while read -r key value; do echo "$key=$value" >> $GITHUB_ENV && echo "Variable $key has been set"; done
          else
            echo "ADDITIONAL_VARIABLES secret you supplied is not a valid JSON object. Check the formatting of the secret."
            exit 1
          fi
      - name: Git checkout
        uses: actions/checkout@v3

      - name: 'Bootstrap up the Node.js environment'
        uses: ./.github/actions/bootstrap-nextjs
        with:
          runner: ${{ inputs.runner }}
          package_manager: ${{ inputs.package_manager }}
          node_version: ${{ inputs.node_version }}
          env_vars: ${{ inputs.env_vars }}

      - name: Run build
        shell: bash
        id: 'build'
        run: 'npm run build'

      - id: commit
        uses: pr-mpt/actions-commit-hash@v1

      - name: Create release folder
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.deploy_host }}
          username: ${{ inputs.deploy_user }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.INSTANCE_PORT }}
          script: |
            mkdir -p ~/www/${{ inputs.deploy_host }}/releases/${{ steps.commit.outputs.short }}
      - name: Copy deployment
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr
          path: .next/standalone/
          remote_path: /home/${{ inputs.deploy_user }}/www/${{ inputs.deploy_host }}/releases/${{ steps.commit.outputs.short }}/
          remote_host: ${{ inputs.deploy_host }}
          remote_port: ${{ secrets.INSTANCE_PORT }}
          remote_user: ${{ inputs.deploy_user }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to ${{ inputs.environment }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.deploy_host }}
          username: ${{ inputs.deploy_user }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.INSTANCE_PORT }}
          script: |
            cd ~/www/${{ inputs.deploy_host }}/releases/${{ steps.commit.outputs.short }}
      - name: Import Secrets
        if: ${{ contains(inputs.features, 'secrets') }}
        uses: hashicorp/vault-action@v2.4.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: ${{ secrets.VAULT_AUTH_METHOD }}
          roleId: ${{ secrets.VAULT_AUTH_ROLE_ID }}
          secretId: ${{ secrets.VAULT_AUTH_SECRET_ID }}
          secrets: |
            js/js-payroll-calculator/staging secrets | staging_secrets ;
      - name: Add secrets to staging
        if: ${{ contains(inputs.features, 'secrets') }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.deploy_host }}
          username: ${{ inputs.deploy_user }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.INSTANCE_PORT }}
          script: |
            cd ${{ inputs.deploy_to || '/home/' + inputs.deploy_user + '/www/' + inputs.deploy_host }}
            ln -nfs releases/${{ steps.commit.outputs.short }}/ current
            cd current
            npm install @newrelic/next
            echo "::add-mask::${{ env.staging_secrets }}" > .env
            NODE_OPTIONS='-r @newrelic/next' passenger-config restart-app ~/www/${{ inputs.deploy_host }}/current
      - name: Clean up release folder
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.deploy_host }}
          username: ${{ inputs.deploy_user }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.INSTANCE_PORT }}
          script: |
            cd ${{ inputs.deploy_to || '/home/' + inputs.deploy_user + '/www/' + inputs.deploy_host }}/releases/ && ls -tl | tail -n +5 | awk '{print $9}' | xargs rm -rf {}
      - name: Notify on Slack
        env:
          SUCCESS: ${{ steps.deploy-next-ssr.outcome == 'success' }}
          FAILURE: ${{ steps.deploy-next-ssr.outcome == 'failure' }}
          CHANNEL: ${{ inputs.slack_notification_channel }}
          NOTIFY_ON: ${{ inputs.notify_on }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENVIRONMENT: ${{ inputs.environment }}
        if: ${{ always() && inputs.slack_notification_channel }}
        run: |
          if [ -z "$SLACK_BOT_TOKEN" ] ; then
            echo "SLACK_BOT_TOKEN secret is missing from the workflow!"
            exit 1
          fi
          if [[ "$NOTIFY_ON" != "success" && "$NOTIFY_ON" != "failure" && "$NOTIFY_ON" != "all" ]] ; then
            echo "notify_on input is not valid. Must be one of: 'success', 'failure', or 'all'"
            exit 1
          fi
          SHORT_SHA=$(git rev-parse --short HEAD)
          FULL_SHA=$(git rev-parse HEAD)
          COMMIT_MESSAGE=$(git show -s --format=%s)
          GITHUB_RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          GITHUB_COMMIT_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$FULL_SHA"
          if [[ "$SUCCESS" = true && ("$NOTIFY_ON" = "success" || "$NOTIFY_ON" = "all") ]] ; then
            curl -X POST https://slack.com/api/chat.postMessage \
                 -H "Content-type: application/json; charset=utf-8" \
                 -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                 -s -S \
                 -d @- <<- EOF
                  {
                    "channel": "$CHANNEL",
                    "attachments": [
                      {
                        "color": "#19a974",
                        "blocks": [
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "$GITHUB_ACTOR <$GITHUB_RUN_URL|deployed> to *$DEPLOY_ENVIRONMENT*! :tada: \n _ $COMMIT_MESSAGE _ (<$GITHUB_COMMIT_URL|$SHORT_SHA>)"
                            }
                          }
                        ]
                      }
                    ]
                  }
          EOF
          fi
          if [[ "$FAILURE" = true && ("$NOTIFY_ON" = "failure" || "$NOTIFY_ON" = "all") ]] ; then
            curl -X POST https://slack.com/api/chat.postMessage \
                 -H "Content-type: application/json; charset=utf-8" \
                 -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                 -s -S \
                 -d @- <<- EOF
                  {
                    "channel": "$CHANNEL",
                    "attachments": [
                      {
                        "color": "#f75819",
                        "blocks": [
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "$GITHUB_ACTOR failed to <$GITHUB_RUN_URL|deploy> to *$DEPLOY_ENVIRONMENT*! :boom: \n _ $COMMIT_MESSAGE _ (<$GITHUB_COMMIT_URL|$SHORT_SHA>)"
                            }
                          }
                        ]
                      }
                    ]
                  }
          EOF
          fi